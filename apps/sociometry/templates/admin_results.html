{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>{{ texts.results }} - {{ measurement.name }}</h2>
  <p>Kitöltések / submissions: {{ responses|length }}</p>
  <div class="actions">
    <a class="btn" href="{{ url_for('export_excel', measurement_id=measurement.id, lang=lang) }}">{{ texts.download_excel }}</a>
    <a class="btn" href="{{ url_for('export_pdf', measurement_id=measurement.id, lang=lang) }}">{{ texts.download_pdf }}</a>
  </div>
</section>

{% for block in question_blocks %}
<section class="card">
  <h3>{{ loop.index }}. {{ block.item.question_text }}</h3>
  <ul>
    <li>Density / SI: {{ '%.3f'|format(block.metrics.SI) }}</li>
    <li>Reciprocity / KI: {{ '%.3f'|format(block.metrics.KI) }}</li>
    <li>VK: {{ '%.3f'|format(block.metrics.VK) }}</li>
    <li>JI₂: {{ '%.3f'|format(block.metrics.JI2) }}</li>
    <li>KOH: {{ '%.3f'|format(block.metrics.KOH) }}</li>
    <li>CM: {{ '%.3f'|format(block.metrics.CM) }}</li>
    <li>Reciprocal pairs: {{ block.metrics.reciprocal_pairs }}</li>
    <li>Isolates: {{ block.metrics.isolates }}</li>
  </ul>

  <div class="table-wrap">
    <table class="summary-table">
      <thead>
        <tr>
          <th>Mutató</th>
          <th>Érték</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>KI</td><td>{{ '%.4f'|format(block.metrics.KI) }}</td></tr>
        <tr><td>VK</td><td>{{ '%.4f'|format(block.metrics.VK) }}</td></tr>
        <tr><td>JI₁</td><td>{{ '%.4f'|format(block.metrics.JI1) }}</td></tr>
        <tr><td>JI₂</td><td>{{ '%.4f'|format(block.metrics.JI2) }}</td></tr>
        <tr><td>SI</td><td>{{ '%.4f'|format(block.metrics.SI) }}</td></tr>
        <tr><td>KOH</td><td>{{ '%.4f'|format(block.metrics.KOH) }}</td></tr>
        <tr><td>CM</td><td>{{ '%.4f'|format(block.metrics.CM) }}</td></tr>
        <tr><td>Rokonszenvi szórás (SD)</td><td>{{ '%.4f'|format(block.metrics.SD_rokonszenvi) }}</td></tr>
        <tr><td>Funkcionális szórás (SD)</td><td>{{ '%.4f'|format(block.metrics.SD_funkcionalis) }}</td></tr>
        <tr><td>Csoportlégkör mutató</td><td>{% if block.metrics.Csoportlegkor is not none %}{{ '%.4f'|format(block.metrics.Csoportlegkor) }}{% else %}-{% endif %}</td></tr>
      </tbody>
    </table>
  </div>

  {% if block.item.include_sociogram %}
    <p class="legend-note">Jelmagyarázat: szürke = egyirányú, zöld = egyszeres kölcsönös, narancs = kétszeres kölcsönös, piros = háromszoros vagy több kölcsönös.</p>
    <img src="{{ url_for('sociogram_png', measurement_id=measurement.id, question_index=block.item.question_index, lang=lang) }}" alt="sociogram" class="sociogram" />
  {% endif %}
</section>
{% endfor %}

{% if selected_indices %}
<section class="card">
  <h3>Összesített szociogram / Combined sociogram ({{ selected_indices_display|join(', ') }})</h3>
  {% if combined_metrics %}
  <ul>
    <li>Density / SI: {{ '%.3f'|format(combined_metrics.SI) }}</li>
    <li>Reciprocity / KI: {{ '%.3f'|format(combined_metrics.KI) }}</li>
    <li>VK: {{ '%.3f'|format(combined_metrics.VK) }}</li>
    <li>JI₂: {{ '%.3f'|format(combined_metrics.JI2) }}</li>
    <li>KOH: {{ '%.3f'|format(combined_metrics.KOH) }}</li>
    <li>CM: {{ '%.3f'|format(combined_metrics.CM) }}</li>
    <li>Reciprocal pairs: {{ combined_metrics.reciprocal_pairs }}</li>
    <li>Isolates: {{ combined_metrics.isolates }}</li>
  </ul>
  {% endif %}
  <p class="legend-note">Jelmagyarázat: szürke = egyirányú, zöld = egyszeres kölcsönös, narancs = kétszeres kölcsönös, piros = háromszoros vagy több kölcsönös.</p>
  <img src="{{ url_for('sociogram_combined_png', measurement_id=measurement.id, lang=lang) }}" alt="combined sociogram" class="sociogram" />
</section>
{% endif %}

<section class="card">
  <h3>Összesített név szerinti tábla / Name summary</h3>
  <div class="table-wrap">
    <table class="summary-table">
      <thead>
        <tr>
          {% if name_summary_rows %}
            {% for key in name_summary_rows[0].keys() %}
              <th>{{ key }}</th>
            {% endfor %}
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for row in name_summary_rows %}
          <tr>
            {% for value in row.values() %}
              <td>{{ value }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
